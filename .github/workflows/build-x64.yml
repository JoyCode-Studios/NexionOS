name: Build NexionOS x64 (Debian Bookworm)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-x64:
    runs-on: ubuntu-latest

    steps:
      - name: ‚¨áÔ∏è Checkout repository
        uses: actions/checkout@v4

      - name: üì¶ Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            live-build \
            debootstrap \
            squashfs-tools \
            xorriso \
            isolinux \
            syslinux-common \
            git
          sudo apt-get clean
          rm -rf /var/lib/apt/lists/*

      - name: ‚öôÔ∏è Configure build directory
        run: |
          BUILD_DIR="$GITHUB_WORKSPACE/nexion-live"
          cd "$BUILD_DIR"
          
          # Clean old state
          sudo lb clean || true

          # Make sure config folder is correct (do NOT copy over itself)
          if [ ! -d "config" ]; then
            echo "‚ùå Config folder missing in nexion-live!"
            exit 1
          fi

          # Configure live-build
          sudo lb config \
            --distribution bookworm \
            --architecture amd64 \
            --archive-areas "main contrib non-free non-free-firmware" \
            --initramfs live-boot \
            --debian-installer none \
            --mirror-bootstrap http://deb.debian.org/debian/ \
            --mirror-chroot http://deb.debian.org/debian/ \
            --mirror-binary http://deb.debian.org/debian/ \
            --binary-images iso-hybrid \
            --apt-indices false

      - name: üõ†Ô∏è Build ISO
        run: |
          BUILD_DIR="$GITHUB_WORKSPACE/nexion-live"
          cd "$BUILD_DIR"
          sudo lb build

          echo "=== Checking for ISO ==="
          ls -lah

          if [ -f live-image-amd64.hybrid.iso ]; then
            ISO_NAME="NexionOS-Bookworm-x64.iso"
            cp live-image-amd64.hybrid.iso "$GITHUB_WORKSPACE/$ISO_NAME"
            echo "‚úÖ ISO created successfully!"
          else
            echo "‚ùå ISO not found!"
            find . -name "*.iso"
            exit 1
          fi

      - name: ‚¨ÜÔ∏è Upload ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: NexionOS-Bookworm-x64-ISO
          path: NexionOS-Bookworm-x64.iso
          retention-days: 7

      - name: üìä Final Info
        if: success()
        run: |
          echo "‚úÖ Workflow completed successfully!"
          echo "üì¶ Artifact: NexionOS-Bookworm-x64-ISO"
          echo "üíæ ISO size: $(du -h $GITHUB_WORKSPACE/NexionOS-Bookworm-x64.iso | cut -f1)"
