name: Build NexionOS x64 (Debian Bookworm Full ISO)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-x64:
    runs-on: ubuntu-latest
    container:
      image: debian:bookworm
      options: --privileged --security-opt seccomp=unconfined

    steps:
      - name: ‚¨áÔ∏è Checkout repository
        uses: actions/checkout@v4

      - name: üì¶ Install dependencies
        run: |
          apt-get update
          apt-get install -y --no-install-recommends \
            live-build \
            debootstrap \
            squashfs-tools \
            xorriso \
            isolinux \
            syslinux-common \
            git \
            initramfs-tools \
            sudo
          apt-get clean
          rm -rf /var/lib/apt/lists/*

      - name: ‚öôÔ∏è Configure and Build ISO
        run: |
          WORKDIR="$GITHUB_WORKSPACE/nexion-live"
          cd "$WORKDIR"

          echo "=== Cleaning old build ==="
          sudo lb clean || true

          echo "=== Copying config folder (if needed) ==="
          if [ -d "$WORKDIR/config" ]; then
            sudo cp -rv "$WORKDIR/config"/* config/
          fi

          echo "=== Configuring live-build ==="
          sudo lb config \
            --distribution bookworm \
            --architecture amd64 \
            --archive-areas "main contrib non-free non-free-firmware" \
            --debian-installer none \
            --binary-images iso-hybrid \
            --mirror-bootstrap http://deb.debian.org/debian/ \
            --mirror-chroot http://deb.debian.org/debian/ \
            --mirror-binary http://deb.debian.org/debian/ \
            --apt-indices false

          echo "=== Starting ISO build ==="
          sudo lb build

          echo "=== Checking for ISO ==="
          if [ -f live-image-amd64.hybrid.iso ]; then
            ISO_NAME="NexionOS-Bookworm-x64-Full.iso"
            cp live-image-amd64.hybrid.iso "$GITHUB_WORKSPACE/$ISO_NAME"
            echo "‚úÖ ISO created successfully!"
          else
            echo "‚ùå ISO not found!"
            find . -name "*.iso"
            exit 1
          fi

      - name: ‚¨ÜÔ∏è Upload ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: NexionOS-Bookworm-x64-Full-ISO
          path: NexionOS-Bookworm-x64-Full.iso
          retention-days: 7

      - name: üìä Display final info
        if: success()
        run: |
          echo "‚úÖ Workflow completed successfully!"
          echo "üì¶ Artifact name: NexionOS-Bookworm-x64-Full-ISO"
          echo "üíæ ISO size: $(du -h $GITHUB_WORKSPACE/NexionOS-Bookworm-x64-Full.iso | cut -f1)"
          echo "üîó Download from the Artifacts section"
