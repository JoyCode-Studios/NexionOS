name: Build NexionOS x64 (Debian Bookworm)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: # Allows manual trigger

jobs:
  build-x64:
    runs-on: ubuntu-latest
    
    steps:
      - name: ‚¨áÔ∏è Checkout repository
        uses: actions/checkout@v4

      - name: üêã Build ISO in Debian Docker Container
        run: |
          docker run --rm --privileged \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            debian:bookworm-slim \
            bash -c '
              # Update and install dependencies
              apt-get update
              apt-get install -y \
                live-build \
                debootstrap \
                squashfs-tools \
                xorriso \
                isolinux \
                syslinux-common
              
              # Create build directory
              mkdir -p nexion-live
              cd nexion-live
              
              # Configure live-build
              lb config \
                --distribution bookworm \
                --architecture amd64 \
                --archive-areas "main contrib non-free non-free-firmware"
              
              # Build the ISO
              lb build
              
              # Rename with timestamp and move to workspace root
              TIMESTAMP=$(date +%Y%m%d_%H%M%S)
              if [ -f live-image-amd64.hybrid.iso ]; then
                mv live-image-amd64.hybrid.iso ../NexionOS-Bookworm-x64-${TIMESTAMP}.iso
                ls -lh ../NexionOS-Bookworm-x64-${TIMESTAMP}.iso
                echo "‚úÖ ISO built successfully!"
              else
                echo "‚ùå ISO file not found!"
                ls -la
                exit 1
              fi
            '
      
      - name: üîç Verify ISO exists
        run: |
          echo "=== Files in workspace ==="
          ls -lah ${{ github.workspace }}/
          echo "=== Looking for ISO ==="
          find ${{ github.workspace }} -name "*.iso" -type f

      - name: ‚¨ÜÔ∏è Upload NexionOS ISO Artifact
        uses: actions/upload-artifact@v4
        with:
          name: NexionOS-Bookworm-x64-ISO
          path: NexionOS-Bookworm-x64-*.iso
          retention-days: 7
          if-no-files-found: error
