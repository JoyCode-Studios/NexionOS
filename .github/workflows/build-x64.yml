name: Build NexionOS ISO (x64 + ARM64)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: debian:bookworm
      options: --privileged --security-opt seccomp=unconfined

    steps:
      - name: üõ† Install system dependencies
        run: |
          apt-get update
          apt-get install -y \
            ca-certificates \
            sudo \
            live-build \
            debootstrap \
            squashfs-tools \
            xorriso \
            isolinux \
            syslinux-common \
            git \
            initramfs-tools \
            qemu-user-static \
            binfmt-support
          apt-get clean
          rm -rf /var/lib/apt/lists/*

      - name: ‚¨áÔ∏è Checkout repository
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Build x64 ISO
        run: |
          WORKDIR="$GITHUB_WORKSPACE/nexion-live"
          cd "$WORKDIR"
          echo "=== Cleaning old x64 build ==="
          sudo lb clean || true
          echo "=== Copying config folder ==="
          # Only copy if config exists and avoid overwriting itself
          if [ -d config ]; then
            echo "Config folder exists, skipping copy"
          else
            cp -rv "$WORKDIR/config" "$WORKDIR/config"
          fi
          echo "=== Configuring live-build for x64 ==="
          sudo lb config \
            --distribution bookworm \
            --architecture amd64 \
            --archive-areas "main contrib non-free non-free-firmware" \
            --debian-installer none \
            --binary-images iso-hybrid \
            --mirror-bootstrap http://deb.debian.org/debian/ \
            --mirror-chroot http://deb.debian.org/debian/ \
            --mirror-binary http://deb.debian.org/debian/ \
            --initramfs live-boot
          echo "=== Starting x64 build ==="
          sudo lb build
          echo "=== Checking x64 ISO ==="
          if [ -f live-image-amd64.hybrid.iso ]; then
            ISO_NAME="NexionOS-Bookworm-x64.iso"
            cp live-image-amd64.hybrid.iso "$GITHUB_WORKSPACE/$ISO_NAME"
            echo "‚úÖ x64 ISO created: $ISO_NAME"
          else
            echo "‚ùå x64 ISO not found!"
            exit 1
          fi

      - name: ‚öôÔ∏è Build ARM64 ISO
        run: |
          WORKDIR="$GITHUB_WORKSPACE/nexion-live-arm64"
          mkdir -p "$WORKDIR"
          cp -r "$GITHUB_WORKSPACE/nexion-live/"* "$WORKDIR/"
          cd "$WORKDIR"
          echo "=== Cleaning old ARM64 build ==="
          sudo lb clean || true
          echo "=== Configuring live-build for ARM64 ==="
          sudo lb config \
            --distribution bookworm \
            --architecture arm64 \
            --archive-areas "main contrib non-free non-free-firmware" \
            --debian-installer none \
            --binary-images iso-hybrid \
            --mirror-bootstrap http://deb.debian.org/debian/ \
            --mirror-chroot http://deb.debian.org/debian/ \
            --mirror-binary http://deb.debian.org/debian/ \
            --initramfs live-boot
          echo "=== Starting ARM64 build ==="
          sudo lb build
          echo "=== Checking ARM64 ISO ==="
          if [ -f live-image-arm64.hybrid.iso ]; then
            ISO_NAME="NexionOS-Bookworm-ARM64.iso"
            cp live-image-arm64.hybrid.iso "$GITHUB_WORKSPACE/$ISO_NAME"
            echo "‚úÖ ARM64 ISO created: $ISO_NAME"
          else
            echo "‚ùå ARM64 ISO not found!"
            exit 1
          fi

      - name: ‚¨ÜÔ∏è Upload ISOs
        uses: actions/upload-artifact@v4
        with:
          name: NexionOS-ISOs
          path: |
            ${{ github.workspace }}/NexionOS-Bookworm-x64.iso
            ${{ github.workspace }}/NexionOS-Bookworm-ARM64.iso
          retention-days: 7

      - name: üìä Summary
        if: success()
        run: |
          echo "‚úÖ Workflow completed successfully!"
          ls -lh $GITHUB_WORKSPACE/*.iso
