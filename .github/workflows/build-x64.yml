name: Build NexionOS ISO

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-x64:
    runs-on: ubuntu-latest
    env:
      WORKDIR: ${{ github.workspace }}/nexion-live
      ISO_NAME: NexionOS-Bookworm-x64-GNOME.iso
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: üì¶ Install base dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            debootstrap \
            squashfs-tools \
            xorriso \
            isolinux \
            syslinux-common \
            git \
            wget \
            curl \
            gnupg
          sudo apt-get clean
      
      - name: üöÄ Install latest live-build from Debian Backports
        run: |
          # Import Debian GPG keys properly
          sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 6ED0E7B82643E131
          sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 78DBA3BC47EF2265
          
          # Add Debian Bookworm Backports repository
          echo "deb http://deb.debian.org/debian bookworm-backports main" | sudo tee /etc/apt/sources.list.d/backports.list
          
          # Update and install latest live-build
          sudo apt-get update
          sudo apt-get install -y -t bookworm-backports live-build
          
          echo "‚úÖ live-build updated to latest version"
          lb --version
      
      - name: Setup WORKDIR
        run: |
          mkdir -p $WORKDIR
          cd $WORKDIR
          sudo lb clean --purge || true
      
      - name: Copy config from repo
        run: |
          cd $WORKDIR
          if [ -d "$GITHUB_WORKSPACE/config" ]; then
            echo "=== Copying config from repo ==="
            cp -rv "$GITHUB_WORKSPACE/config"/* config/ || cp -rv "$GITHUB_WORKSPACE/config" .
            echo "=== Config copied ==="
            ls -lah config/
          else
            echo "‚ö†Ô∏è No config directory found"
          fi
      
      - name: Configure live-build
        run: |
          cd $WORKDIR
          sudo lb config \
            --distribution bookworm \
            --architecture amd64 \
            --archive-areas "main contrib non-free non-free-firmware" \
            --debian-installer none \
            --binary-images iso-hybrid \
            --apt-indices false
      
      - name: Build ISO
        run: |
          cd $WORKDIR
          sudo lb build
          
          echo "=== Checking for ISO ==="
          if [ -f live-image-amd64.hybrid.iso ]; then
            cp live-image-amd64.hybrid.iso $GITHUB_WORKSPACE/$ISO_NAME
            echo "‚úÖ ISO created successfully: $ISO_NAME"
            ls -lh $GITHUB_WORKSPACE/$ISO_NAME
          else
            echo "‚ùå ISO not found!"
            find . -name "*.iso"
            exit 1
          fi
      
      - name: Upload ISO
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ISO_NAME }}
          path: ${{ github.workspace }}/${{ env.ISO_NAME }}
