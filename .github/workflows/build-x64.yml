name: Build NexionOS ISO

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build-iso:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Install live-build + tools
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          live-build \
          syslinux \
          isolinux \
          xorriso \
          squashfs-tools \
          curl \
          ca-certificates

    - name: Show environment
      run: |
        echo "GITHUB_WORKSPACE = $GITHUB_WORKSPACE"
        ls -al "$GITHUB_WORKSPACE"

    - name: Move into nexion-live
      run: |
        if [ ! -d "$GITHUB_WORKSPACE/nexion-live" ]; then
          echo "ERROR: nexion-live folder not found"
          exit 1
        fi
        ls -al "$GITHUB_WORKSPACE/nexion-live"

    - name: Clean previous build
      working-directory: ${{ github.workspace }}/nexion-live
      run: |
        echo "=== Cleaning old build ==="
        sudo lb clean --purge

    - name: Configure build (safety)
      working-directory: ${{ github.workspace }}/nexion-live
      run: |
        echo "=== Running lb config (ensure configs are applied) ==="
        sudo lb config \
          --distribution bookworm \
          --architectures amd64 \
          --archive-areas "main contrib non-free non-free-firmware"

    - name: Build ISO
      working-directory: ${{ github.workspace }}/nexion-live
      run: |
        echo "=== Starting build ==="
        sudo lb build --debug

    - name: Upload ISO artifact
      uses: actions/upload-artifact@v4
      with:
        name: nexionos-iso
        path: nexion-live/*.iso
