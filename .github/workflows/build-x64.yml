name: Build NexionOS ISO

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-x64:
    runs-on: ubuntu-latest
    env:
      WORKDIR: ${{ github.workspace }}/nexion-live
      ISO_NAME: NexionOS-Bookworm-x64-GNOME.iso

    steps:
      # Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # üì¶ Install initial dependencies (Do NOT install live-build here yet)
      - name: üì¶ Install base dependencies
        run: |
          # Only install supporting tools, we will install a newer live-build later.
          sudo apt-get update
          sudo apt-get install -y \
            debootstrap \
            squashfs-tools \
            xorriso \
            isolinux \
            syslinux-common \
            git \
            wget \
            curl
          sudo apt-get clean

      # üöÄ CRITICAL FIX: Install latest live-build from Backports
      # This step should fix the repository error by using modern live-build logic.
      - name: Install latest live-build from Backports
        run: |
          echo "deb http://deb.debian.org/debian bookworm-backports main" | sudo tee /etc/apt/sources.list.d/backports.list
          sudo apt update
          # Install live-build from backports (-t specifies target release)
          sudo apt install live-build -t bookworm-backports -y
          echo "‚úÖ live-build updated to modern version."
          lb --version

      # Setup working directory and PURGE old caches
      - name: Setup WORKDIR and Purge Cache
        run: |
          mkdir -p $WORKDIR
          cd $WORKDIR
          # CRITICAL STEP: Aggressively clean up previous build artifacts and caches.
          sudo lb clean --purge || true 

      # Copy config folder if not already present
      - name: Copy config folder
        run: |
          cd $WORKDIR
          # NOTE: The original logic here seems redundant/incorrect.
          # Assuming your config files are in the root and need to be moved to $WORKDIR/config
          if [ ! -d config ]; then
            # We assume your config files (like bootstrap) are in the root of the repo
            cp -r ./* config/ 
          fi
          
      # Configure live-build (Simplified - relies on updated live-build and config files)
      - name: Configure live-build
        run: |
          cd $WORKDIR
          # We rely on the config files (like config/bootstrap) to provide mirrors/suites.
          # NOTE: The missing --apt-recommends false is recommended for small ISO size.
          sudo lb config \
            --distribution bookworm \
            --architecture amd64 \
            --archive-areas "main contrib non-free non-free-firmware" \
            --debian-installer none \
            --binary-images iso-hybrid \
            --initramfs live-boot \
            --apt-indices false \
            --apt-recommends false

      # Build ISO
      - name: Build ISO
        run: |
          cd $WORKDIR
          sudo lb build
          
          echo "=== Checking for ISO ==="
          if [ -f live-image-amd64.hybrid.iso ]; then
            cp live-image-amd64.hybrid.iso $GITHUB_WORKSPACE/$ISO_NAME
            echo "‚úÖ ISO created successfully: $ISO_NAME"
          else
            echo "‚ùå ISO not found!"
            find . -name "*.iso"
            exit 1
          fi

      # Upload artifact
      - name: Upload ISO
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ISO_NAME }}
          path: ${{ github.workspace }}/${{ env.ISO_NAME }}
