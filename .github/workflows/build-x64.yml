name: Build NexionOS x64 (Debian Bookworm with GNOME)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-x64:
    runs-on: ubuntu-latest
    container:
      image: debian:bookworm
      options: --privileged --security-opt seccomp=unconfined
      
    steps:
      - name: üì¶ Install dependencies and fix initramfs link
        run: |
          apt-get update
          apt-get install -y \
            live-build \
            debootstrap \
            squashfs-tools \
            xorriso \
            isolinux \
            syslinux-common \
            git \
            initramfs-tools
          
          # CRITICAL FIX: Create a symlink to satisfy the missing 'initramfs-tools' command
          # This should resolve the 'initramfs-tools: not found' error (exit code 127).
          ln -s /usr/sbin/update-initramfs /usr/local/bin/initramfs-tools
          
          apt-get clean
          rm -rf /var/lib/apt/lists/*
          
      - name: ‚¨áÔ∏è Checkout repository
        uses: actions/checkout@v4
        
      - name: ‚öôÔ∏è Configure and Build ISO (with GNOME)
        run: |
          BUILD_DIR=/tmp/nexion-live
          mkdir -p $BUILD_DIR
          cd $BUILD_DIR
                    
          # Always start clean to avoid stale config
          lb clean
          rm -rf config
                    
          # Configure live-build with the corrected flag
          lb config \
            --distribution bookworm \
            --architecture amd64 \
            --archive-areas "main contrib non-free non-free-firmware" \
            --initramfs debian \  # <-- FIX: Corrected system name
            --debian-installer none \
            --mirror-bootstrap http://deb.debian.org/debian/ \
            --mirror-chroot http://deb.debian.org/debian/
                    
          # Copy your existing config directory from repo
          if [ -d "$GITHUB_WORKSPACE/config" ]; then
            echo "=== Copying existing config from repo ==="
            cp -rv "$GITHUB_WORKSPACE/config"/* config/
            echo "=== Package lists found: ==="
            ls -lah config/package-lists/
          else
            echo "‚ùå No config directory found in repo!"
            exit 1
          fi
                    
          echo "=== Starting build with GNOME ==="
          lb build
                    
          echo "=== Checking for ISO ==="
          ls -lah
                    
          if [ -f live-image-amd64.hybrid.iso ]; then
            ISO_NAME="NexionOS-Bookworm-x64-GNOME.iso"
            cp live-image-amd64.hybrid.iso $GITHUB_WORKSPACE/$ISO_NAME
            echo "‚úÖ GNOME ISO created successfully!"
            ls -lh $GITHUB_WORKSPACE/$ISO_NAME
          else
            echo "‚ùå ISO not found!"
            find . -name "*.iso"
            exit 1
          fi
          
      - name: ‚¨ÜÔ∏è Upload GNOME ISO
        uses: actions/upload-artifact@v4
        with:
          name: NexionOS-Bookworm-x64-GNOME-ISO
          path: NexionOS-Bookworm-x64-GNOME.iso
          retention-days: 7
          
      - name: üìä Display final info
        if: success()
        run: |
          echo "‚úÖ Workflow completed successfully!"
          echo "üì¶ Artifact name: NexionOS-Bookworm-x64-GNOME-ISO"
          echo "üíæ ISO size: $(du -h $GITHUB_WORKSPACE/NexionOS-Bookworm-x64-GNOME.iso | cut -f1)"
          echo "üîó Download from the Artifacts section"
