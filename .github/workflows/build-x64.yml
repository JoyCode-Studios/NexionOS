name: Build NexionOS ISO

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-x64:
    runs-on: ubuntu-latest
    env:
      WORKDIR: ${{ github.workspace }}/nexion-live
      ISO_NAME: NexionOS-Bookworm-x64-GNOME.iso

    steps:
      # Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # Install dependencies
      - name: üì¶ Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            live-build \
            debootstrap \
            squashfs-tools \
            xorriso \
            isolinux \
            syslinux-common \
            git \
            wget \
            curl
          sudo apt-get clean

      # Setup working directory and PURGE old caches
      - name: Setup WORKDIR and Purge Cache
        run: |
          mkdir -p $WORKDIR
          cd $WORKDIR
          # CRITICAL STEP: Aggressively clean up previous build artifacts and caches.
          # This prevents persistent repository errors from cached bootstrap stages.
          sudo lb clean --purge || true 

      # Copy config folder if not already present
      - name: Copy config folder
        run: |
          cd $WORKDIR
          if [ ! -d config ]; then
            cp -r $WORKDIR/* config/
          fi

      # Configure live-build (FINAL FIX: Command-line mirror overrides)
      - name: Configure live-build
        run: |
          cd $WORKDIR
          sudo lb config \
            --distribution bookworm \
            --archive-areas "main contrib non-free non-free-firmware" \
            --architecture amd64 \
            --debian-installer none \
            --binary-images iso-hybrid \
            --initramfs live-boot \
            --mirror-bootstrap http://deb.debian.org/debian/ \
            --mirror-chroot http://deb.debian.org/debian/ \
            --mirror-binary http://deb.debian.org/debian/ \
            --security true \
            --security-suite bookworm-security \
            --security-mirror-chroot http://security.debian.org/debian-security \
            --security-mirror-binary http://security.debian.org/debian-security \
            --apt-indices false

      # Build ISO
      - name: Build ISO
        run: |
          cd $WORKDIR
          sudo lb build
          
          echo "=== Checking for ISO ==="
          if [ -f live-image-amd64.hybrid.iso ]; then
            cp live-image-amd64.hybrid.iso $GITHUB_WORKSPACE/$ISO_NAME
            echo "‚úÖ ISO created successfully: $ISO_NAME"
          else
            echo "‚ùå ISO not found!"
            find . -name "*.iso"
            exit 1
          fi

      # Upload artifact
      - name: Upload ISO
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ISO_NAME }}
          path: ${{ github.workspace }}/${{ env.ISO_NAME }}
