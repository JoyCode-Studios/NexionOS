name: Build NexionOS x64 (Debian Bookworm GNOME)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-x64:
    runs-on: ubuntu-latest

    steps:
      - name: ‚¨áÔ∏è Checkout repository
        uses: actions/checkout@v4

      - name: üõ† Install Debian Live-Build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            debootstrap \
            squashfs-tools \
            xorriso \
            isolinux \
            syslinux-common \
            live-build \
            git \
            dosfstools \
            ca-certificates

      - name: ‚öôÔ∏è Configure live-build
        run: |
          WORKDIR=$HOME/nexion-build
          mkdir -p $WORKDIR
          cd $WORKDIR

          # Clean old state (just in case)
          sudo lb clean || true
          sudo rm -rf config

          # Main configuration
          sudo lb config \
            --distribution bookworm \
            --archive-areas "main contrib non-free non-free-firmware" \
            --architecture amd64 \
            --initramfs initramfs \
            --debian-installer none \
            --mirror-bootstrap http://deb.debian.org/debian/ \
            --mirror-chroot http://deb.debian.org/debian/ \
            --mirror-binary http://deb.debian.org/debian/ \
            --binary-images iso-hybrid \
            --apt-indices false

          echo "=== Copying your config/ folder ==="
          cp -rv $GITHUB_WORKSPACE/config/* config/

          echo "=== Contents of package lists ==="
          ls -lah config/package-lists/

      - name: üöÄ Build ISO
        run: |
          cd $HOME/nexion-build
          sudo lb build

          echo "=== Checking for ISO ==="
          ls -lah

          if [ -f live-image-amd64.hybrid.iso ]; then
            ISO_NAME="NexionOS-Bookworm-x64-GNOME.iso"
            cp live-image-amd64.hybrid.iso $GITHUB_WORKSPACE/$ISO_NAME
            echo "ISO successfully created!"
          else
            echo "‚ùå ISO NOT FOUND"
            find . -name "*.iso"
            exit 1
          fi

      - name: üì§ Upload ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: NexionOS-Bookworm-x64-GNOME
          path: NexionOS-Bookworm-x64-GNOME.iso
          retention-days: 7
