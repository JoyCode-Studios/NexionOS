name: Build NexionOS x64 (Debian Bookworm with GNOME)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-x64:
    runs-on: ubuntu-latest
    container:
      image: debian:bookworm
      options: --privileged --security-opt seccomp=unconfined
    
    steps:
      - name: ðŸ“¦ Install dependencies
        run: |
          apt-get update
          apt-get install -y \
            live-build \
            debootstrap \
            squashfs-tools \
            xorriso \
            isolinux \
            syslinux-common \
            git
          apt-get clean
          rm -rf /var/lib/apt/lists/*

      - name: â¬‡ï¸ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ”§ Fix live-build Ubuntu hardcoding
        run: |
          sed -i 's/ubuntu/debian/g' /usr/lib/live/build/bootstrap_debootstrap
          sed -i 's/archive.ubuntu.com/deb.debian.org/g' /usr/lib/live/build/bootstrap_debootstrap
          if [ -f /usr/lib/live/build/config ]; then
            sed -i 's/ubuntu/debian/g' /usr/lib/live/build/config
          fi
          echo "=== Patched live-build scripts ==="

      - name: âš™ï¸ Configure and Build ISO (with GNOME)
        run: |
          mkdir -p /tmp/nexion-live
          cd /tmp/nexion-live
          
          # Configure live-build
          lb config \
            --distribution bookworm \
            --architecture amd64 \
            --archive-areas "main contrib non-free non-free-firmware" \
            --initramfs live-boot \
            --mirror-bootstrap http://deb.debian.org/debian/ \
            --mirror-chroot http://deb.debian.org/debian/
          
          # Add GNOME packages - FULL desktop environment (no Firefox/LibreOffice)
          mkdir -p config/package-lists
          cat > config/package-lists/desktop.list.chroot << 'EOF'
          task-gnome-desktop
          gnome-core
          gdm3
          network-manager
          gnome-terminal
          gnome-system-monitor
          gnome-calculator
          gnome-text-editor
          file-roller
          EOF
          
          echo "=== Starting build with GNOME ==="
          lb build
          
          echo "=== Checking for ISO ==="
          ls -lah
          
          if [ -f live-image-amd64.hybrid.iso ]; then
            cp live-image-amd64.hybrid.iso $GITHUB_WORKSPACE/NexionOS-Bookworm-x64-GNOME.iso
            echo "âœ… GNOME ISO created successfully!"
            ls -lh $GITHUB_WORKSPACE/NexionOS-Bookworm-x64-GNOME.iso
          else
            echo "âŒ ISO not found!"
            find . -name "*.iso"
            exit 1
          fi

      - name: â¬†ï¸ Upload GNOME ISO
        uses: actions/upload-artifact@v4
        with:
          name: NexionOS-Bookworm-x64-GNOME-ISO
          path: NexionOS-Bookworm-x64-GNOME.iso
          retention-days: 7
      
      - name: ðŸ“Š Display final info
        if: success()
        run: |
          echo "âœ… Workflow completed successfully!"
          echo "ðŸ“¦ Artifact name: NexionOS-Bookworm-x64-GNOME-ISO"
          echo "ðŸ’¾ ISO size: $(du -h $GITHUB_WORKSPACE/NexionOS-Bookworm-x64-GNOME.iso | cut -f1)"
          echo "ðŸ”— Download from the Artifacts section"
