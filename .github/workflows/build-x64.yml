name: Build NexionOS x64 (Debian Bookworm)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: # Allows manual trigger

jobs:
  build-x64:
    runs-on: ubuntu-latest
    
    steps:
      - name: ‚¨áÔ∏è Checkout repository
        uses: actions/checkout@v4

      - name: üêã Build ISO in Debian Docker Container
        run: |
          docker run --rm --privileged \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            debian:bookworm-slim \
            bash -c '
              # Update and install dependencies
              apt-get update
              apt-get install -y \
                live-build \
                debootstrap \
                squashfs-tools \
                xorriso \
                isolinux \
                syslinux-common
              
              # Create build directory
              mkdir -p nexion-live
              cd nexion-live
              
              # Configure live-build
              lb config \
                --distribution bookworm \
                --architecture amd64 \
                --archive-areas "main contrib non-free non-free-firmware" \
                --initramfs live-boot
              
              # Build the ISO (with verbose output)
              echo "=== Starting lb build ==="
              lb build 2>&1 | tee build.log
              BUILD_EXIT=${PIPESTATUS[0]}
              
              echo "=== Build exit code: $BUILD_EXIT ==="
              echo "=== Last 50 lines of build log ==="
              tail -50 build.log
              
              echo "=== After build, looking for ISO ==="
              ls -lah
              find . -name "*.iso" -o -name "*.img" -o -name "*.hybrid.*"
              
              if [ $BUILD_EXIT -ne 0 ]; then
                echo "‚ùå Build failed with exit code $BUILD_EXIT"
                exit $BUILD_EXIT
              fi
              
              # Rename with timestamp
              TIMESTAMP=$(date +%Y%m%d_%H%M%S)
              if [ -f live-image-amd64.hybrid.iso ]; then
                mv live-image-amd64.hybrid.iso NexionOS-Bookworm-x64-${TIMESTAMP}.iso
                ls -lh NexionOS-Bookworm-x64-${TIMESTAMP}.iso
                echo "‚úÖ ISO built successfully!"
              elif [ -f live-image-amd64.iso ]; then
                mv live-image-amd64.iso NexionOS-Bookworm-x64-${TIMESTAMP}.iso
                ls -lh NexionOS-Bookworm-x64-${TIMESTAMP}.iso
                echo "‚úÖ ISO built successfully!"
              else
                echo "‚ùå ISO file not found after successful build!"
                echo "Available files:"
                ls -la
                echo "=== Checking binary directory ==="
                ls -lah binary/ 2>/dev/null || echo "No binary directory"
                exit 1
              fi
            '
      
      - name: üîç List files to debug
        run: |
          echo "=== Contents of nexion-live ==="
          ls -lah nexion-live/
          echo "=== Find all ISOs ==="
          find nexion-live/ -name "*.iso" -o -name "*.img" 2>/dev/null || echo "No ISO files found"
          echo "=== Find all files (recursively) ==="
          find nexion-live/ -type f | head -20

      - name: ‚¨ÜÔ∏è Upload NexionOS ISO Artifact
        uses: actions/upload-artifact@v4
        with:
          name: NexionOS-Bookworm-x64-ISO
          path: nexion-live/*.iso
          retention-days: 7
          if-no-files-found: error
